#!/usr/bin/perl -wT

use strict;
use CGI;
use Data::Dumper;
use List::Util 'shuffle', 'min', 'max' ;
use POSIX;
use XML::Simple;
###################################################
# Using findbin to locate our new City.pm module
use FindBin qw/$Bin/;
BEGIN {
    # A rather useless regex, but whatever. 
    # Who woulda throught checking for taint stinks? :D
    if ($Bin =~ m!([\w\.\-/]+)!) {
        $Bin = $1;
    } else {
        print STDOUT "Bad directory $Bin\n";
    }
}
use lib "$Bin/";
###################################################
use City 'build_city', 'd' ;


my $xml = new XML::Simple;

###########################################################
# Yes, this is sloppy. I am aware, but it's also unique.
# Unique, Ubiquitous Singletons.
our $q = CGI->new;
our $xml_data = $xml->XMLin(   "../data.xml", ForceContent => 1, ForceArray  =>[]  );
our $names_data = $xml->XMLin(   "../names.xml", ForceContent => 1, ForceArray  =>[]  );

#########################################################################
# First thing we need to do is establish a city skeleton of information,
# then fill it in as needed by each subsection of the sample text.
#########################################################################
our $city=build_city($q->param('cityid'));


#########################################################################
# Now that $city is fleshed out, we can print it..
#########################################################################

# Show city XML
if (defined $q->param('type') and $q->param('type') eq 'xml' ){
    print $q->header( 'text/xml' );
    print "<?xml version='1.0'  encoding='ISO-8859-1' ?>\n";
    print XMLout($city);
#show city data structure
}elsif (defined $q->param('type') and $q->param('type') eq 'dump' ){
    print $q->header( 'text/plain' );
    print Dumper $city;
# run describe city, but don't print it- useful for debugging
}elsif (defined $q->param('type') and $q->param('type') eq 'debug' ){
    describe_city();
# show the data.xml xml content
}elsif (defined $q->param('type') and $q->param('type') eq 'source' ){
    print $q->header( 'text/xml' );
    print "<?xml version='1.0'  encoding='ISO-8859-1' ?>\n";
    print XMLout($xml_data);
# and if it doesn't match those, do the regular printing of the city.
}else {
    print $q->header;
    print describe_city();
}
        
exit;


#######################################################################################################################
#######################################################################################################################
#######################################################################################################################
#######################################################################################################################
#######################################################################################################################
#######################################################################################################################

sub describe_city {
    my $content=describe_header();
    $content.=describe_summary();
    $content.=describe_geography();
    $content.=describe_cityscape();
    $content.=describe_government();
    $content.=describe_population();
    $content.=describe_economy();
    $content.=describe_current_events();
    $content.=describe_footer();
}

sub get_flag_colors{

    my @colors=shuffle map {  $_->{'hex'} } @{ $city->{'flag'}->{'colors'} };
    return "['". join("','",@colors)."']";

}
sub describe_header{
    my $style=print_style();
    my $flagcolors=get_flag_colors(); 
    my $letter = substr $city->{'name'}, 0,1;
    my $content="        <!DOCTYPE html> 
        <html>
            <head>
                <title>City Generator: $city->{'name'} </title>
            $style
            <script src='/js/flag.js' ></script>
            </head>
            <body onload=\"create_flag($city->{'seed'}, '$letter', $flagcolors)\">";
    return $content;
}
sub describe_footer{
    my $content="
            <footer>
                
                <sub>Note: The purpose of this tool is not to provide you with a complete, logical, feasible city- quite the contrary. The purpose is to give a DM a seed for building their own city. If things don't make sense, try to figure out the conditions that lead to that state. The intersting backstory comes from the DM excercising their imagination.</sub>
                <p><a href='?cityid=$city->{'seed'}&type=xml'>xml version</a>    <a href='?cityid=$city->{'seed'}&type=source'>source data</a>  <a href='?cityid=$city->{'seed'}&type=dump'>raw city data</a> </p>
            </footer>
            </body>
        </html>\n";
    return $content;
}
#######################################################################################################################
#######################################################################################################################
#######################################################################################################################
#######################################################################################################################
#######################################################################################################################
sub describe_precipitation {
    if (defined $city->{'weather'}->{'precip'}){
        return " and ".$city->{'weather'}->{'precip'};
    }else{
        return "";
    }
}
sub describe_thunder {
    if (defined $city->{'weather'}->{'thunder'}){
        return $city->{'weather'}->{'thunder'};
    }else{
        return "";
    }
}

sub describe_events{
    return "<ul class='two-column'><li>".join('</li><li>',@{$city->{'events'}})."</li></ul>";

}

sub describe_current_events{
    my $precipitation=describe_precipitation();
    my $thunder=describe_thunder();
    my $events=describe_events();
    my $content="
                    <section id='currentevents'>
                        <h2>Current Events</h2>
                        <p>You arrive $city->{'time'}->{'content'}, and can find $city->{'visiblepopulation'} citizens wandering the town.</p>
                        <h3>Weather</h3>
                        <p>The sky $city->{'weather'}->{'clouds'}, the air is $city->{'weather'}->{'air'}, and the wind is $city->{'weather'}->{'wind'}. The temperature is $city->{'weather'}->{'temp'}$precipitation. $thunder</p>
                        <h3>Events</h3>
                        <p>Approaching the city, you can find the following events:</p>
                         $events
                    </section>
";

}




#######################################################################################################################
#######################################################################################################################
sub describe_populations{
    my @populations;
    foreach my $race ( reverse sort {$a->{'percent'} <=> $b->{'percent'}} @{$city->{'races'}}  ){
        push @populations, "$race->{'count'} $race->{'name'} ($race->{'percent'}%)";
    }
    return "<ul><li>".join('</li><li>',@populations)."</li></ul>";


}

sub describe_race_relations{
    my $content="";
    my $racecount=scalar(@{$city->{'races'}}) -1;
    my @races= shuffle @{$city->{'races'}};
    my $instigator= pop @races;
    my @relations;
    while ($racecount-- > 0 and  scalar(@races) >0){
        my $victim= pop @races;
        push @relations, "The $instigator->{'name'} population $instigator->{'tolerancedescription'} the $victim->{'name'} population.\n";
        unshift @races, $instigator;
        $instigator=$victim;

    }
    $content.="<p>Relations between races are varied by individuals, but in general:</p>";
    $content.= "<ul class='one-column'>\n<li>".join("</li>\n<li>",@relations)."</li>\n</ul>\n";
    return $content;
}

sub describe_population{
    my $populations=describe_populations();
    my $racerelations=describe_race_relations();
    my $content="
                    <section id='population'>
                        <h2>Population</h2>
                        <p>$city->{'name'} is a $city->{'moraldescription'} and $city->{'orderdescription'} population$city->{'dominant_race'}. Children account for $city->{'population'}->{'children'}->{'percent'}% ($city->{'population'}->{'children'}->{'population'}), and the elderly account for $city->{'population'}->{'elderly'}->{'percent'}% ($city->{'population'}->{'elderly'}->{'population'}) of this $city->{'cityage'}->{'content'} city. Here's the breakdown of this $city->{'poptype'} population:</p>
                        $populations
                        <h3>Race Relations</h3>
                        $racerelations 
                    </section>
";

}
#######################################################################################################################
#######################################################################################################################

sub describe_resources {
    my @resources;
    #return Dumper $city->{'resource'};
    foreach my $resource (sort {$a->{'content'} cmp $b->{'content'}} @{$city->{'resources'}}){
        push @resources, $resource->{'content'};
    }
    return "<ul><li>".join('</li><li>',@resources)."</li></ul>";
}
sub describe_taverns {
    my @taverns;
    my $tavernpoptotal=0;
    foreach my $tavern (sort {$a->{'name'} cmp $b->{'name'}} @{$city->{'taverns'}}){
        my $tavernstring;
        ($tavernstring,$tavernpoptotal) = describe_tavern($tavern,$tavernpoptotal);
        push @taverns, $tavernstring;
    }
    my $content="";
    if  (scalar(@taverns) >0 ){
        $content.="<p>Taverns are often central gathering places for the citizens. You can find the following Taverns:</p>\n";
        $content.="<ul class='one-column'><li>".join('</li><li>',@taverns)."</li></ul>";
    }else{
        $content.="<p>There are no taverns in this town.</p>\n";
    }
    return $content;
}
sub describe_tavern{
    my ($tavern,$tavernpoptotal)=@_;
    #max =d(12+4 )+10=26
    my $tavernmod= &d($city->{'size_modifier'}+$tavern->{'population'})*2 + $city->{'time'}->{'bar_mod'}  ;

    my $tavernpop=max(0,  min(  int($city->{'population'}->{'size'}/2),   $tavernmod  )  );
    if ($tavernpoptotal+$tavernpop <= int($city->{'population'}->{'size'}/2)){
        $tavern->{'pop_count'}= $tavernpop;
        $tavernpoptotal+=$tavernpop;
    }
    my $name="";
    if ( defined $tavern->{'bartender'}->{'fullname'} ){ $name=" named ".$tavern->{'bartender'}->{'fullname'}  }

    return ("<strong>$tavern->{'name'}</strong> is a $tavern->{'size'}, $tavern->{'condition'} tavern where the $tavern->{'class'} gather. The bar is owned by a $tavern->{'bartender'}->{'race'}$name who seems $tavern->{'bartender'}->{'behavior'}. The law $tavern->{'legal'} the patrons, however most violence is handled by $tavern->{'violence'}. Goods are $tavern->{'costdescription'}. You'll find $tavern->{'pop_count'} citizen(s) here.", $tavernpoptotal);
}

sub describe_localinfo{
    my $content="";
    my @localmarket;
    foreach my $market (  @{$city->{'markets'}}  ){
        push @localmarket, $market->{'name'};
    }
    return "<ul class='one-column'><li>".join('</li><li>',@localmarket)."</li></ul>";
    return $content;
}
sub describe_economy{
    my $resources=describe_resources();
    my $taverns=describe_taverns();
    my $localinfo=describe_localinfo();
    my $content="
                    <section id='economy'>
                        <h2>Economy</h2>
                        <p> The economy is $city->{'economydescription'}, magic is $city->{'magicdescription'}, and education is $city->{'educationdescription'}.
                        <h3>Resources</h3>
                            <p>$city->{'name'} is known for the following:</p>$resources
                        <h3>Taverns</h3>
                            $taverns
                        <h3>Local Info</h3>
                         <p>If one were to dig around enough, they could uncover the following:</p>
                        $localinfo 
                    </section>
";

}

#######################################################################################################################

sub describe_secondarypower{
    my $content=" Within the city there is ".$city->{'secondarypower'}->{'power'}. " that ".$city->{'secondarypower'}->{'plot'}." current leadership";
    if(defined $city->{'secondarypower'}->{'subplot'} ){
        $content.=" while secretly ".$city->{'secondarypower'}->{'subplot'};
    }
    return $content.".";
}
sub describe_approval{
    if ($city->{'govtype'}->{'approval_mod'} <-1){
        return "does not approve of"
    }elsif ($city->{'govtype'}->{'approval_mod'} >1){
        return "approves of"
    }else{
        return "is indifferent towards"
    }
}
sub describe_freedom{
    if ($city->{'govtype'}->{'religion'} <-1){
        return "oppressed"
    }elsif ($city->{'govtype'}->{'religion'} >1){
        return "welcomed"
    }else{
        return "neither oppressed nor supported"
    }
}
sub describe_magic{
    if ($city->{'magic'} <-1){
        return "verboten"
    }elsif ($city->{'magic'} >1){
        return "legal and common"
    }else{
        return "looked upon with suspicion"
    }
}
sub describe_relations {
    my @relations;
#print Dumper $city->{'neighbors'} ; 
    foreach my $neighbor (  @{$city->{'neighbors'}}  ){
        push @relations, $neighbor->{'relation'}." ".$neighbor->{'name'};
    }
    return "<ul class='two-column'><li>".join('</li><li>',@relations)."</li></ul>";
}
sub define_tactics{
    if (defined $city->{'tactics'}->{'content'}){
        return " $city->{'tactics'}->{'respect'} for their $city->{'tactics'}->{'content'} and are"
    }else{
        return ""
    }
}

sub describe_military{
    my $walls=$city->{'walls'}->{'content'} ;
    if   ( $city->{'walls'}->{'content'} eq 'none'){    
        $walls="lack of defensible wall";
    }
    my $tactic=define_tactics();
    
    my $content="<p>$city->{'name'} has a $city->{'militarydescription'} attitude towards the military. Their standing army of $city->{'militarystats'}->{'active'} citizens ($city->{'militarystats'}->{'activepercent'}%) is at the ready, with a reserve force of $city->{'militarystats'}->{'reserve'} ($city->{'militarystats'}->{'reservepercent'}%). Of the active duty military, $city->{'militarystats'}->{'para'} ($city->{'militarystats'}->{'parapercent'}%) are special forces and $city->{'militarystats'}->{'kingdom'} ($city->{'militarystats'}->{'kingdompercent'}%) are dedicated to protecting the rest of the $city->{'realm'}.</p>";

    $content.="<p> Under duress, a militia of $city->{'militarystats'}->{'militia'} ($city->{'militarystats'}->{'militiapercent'}%) citizens can be raised. Due to their $city->{'militarydescription'} attitude and $walls, $city->{'name'}  $city->{'fortification'}->{'content'} fortified.</p>";
    $content.="<p>$city->{'name'} fighters are $city->{'weapons'}->{'respect'} for their use of $city->{'weapons'}->{'content'} in battle. They are$tactic considered $city->{'militaryskill'}->{'content'} skilled in battle.</p>";
    return $content;
}

sub describe_government{
    my $secondarypower=describe_secondarypower();
    my $approval=describe_approval();
    my $freedom=describe_freedom();
    my $magic=describe_magic();
    my $relations=describe_relations();
    my $military=describe_military();
    my $content="
                    <section id='government'>
                        <h2>Government</h2>
                        <p>$city->{'name'} is ruled by the $city->{'govtype'}->{'respect'} $city->{'govtype'}->{'content'}.$secondarypower The population $approval $city->{'govtype'}->{'content'} policies in general. Freedom of religion is $freedom, and magic use is $magic. </p>

                        <h3>Diplomatic Ties</h3>
                        <p>$city->{'name'} has the following diplomatic relations:</p>
                        $relations
                        <h3>Crime and Punishment</h3>
                        <p>Crime is $city->{'crime'}->{'content'}. Laws are enforced by the $city->{'laws'}->{'enforcer'} $city->{'laws'}->{'enforcement'}. Justice is served $city->{'laws'}->{'trial'}, with a common punishment being $city->{'laws'}->{'punishment'}. The most common crime is $city->{'laws'}->{'commoncrime'}. The imprisonment rate is $city->{'population'}->{'imprisonment'}->{'percent'}% of the population ($city->{'population'}->{'imprisonment'}->{'population'} adult[s]).</p>
                        <h3>Military</h3>
                        $military
                    </section>
";
}
sub describe_district_summary {
    my $content="";
    if (scalar(@{ $city->{'districts'}}) == 1){
         $content=" The city contains a single distinct district.";
    }elsif (scalar(@{ $city->{'districts'}}) > 1){
         $content.=" The city has ".scalar(@{ $city->{'districts'}})." distinct districts.";
    }
    return $content;


}

sub describe_summary {
    if ($city->{'dominant_race'}){$city->{'dominant_race'}=" (which is overwhelmingly ".$city->{'dominant_race'}.")"; }else{$city->{'dominant_race'}=""}
    my $districts=describe_district_summary();
    my $previousid=$city->{'seed'}-1;
    my $nextid=$city->{'seed'}+1;
    my $content="
                    <header>
                       <h1><a href='?cityid=$previousid'>&lt;&lt;</a> <a href='?cityid=$city->{'seed'}'> $city->{'name'} ($city->{'seed'})</a> <a href='?cityid=$nextid'>&gt;&gt;</a></h1>
                        <div style='font-weight:bold;margin:auto;padding:auto;float:right;width:270px;'><div style=''>Official Flag:<br> <canvas style='margin:0 auto;display:block;' id='flagcanvas'> </canvas></div></div>
                        <h2>Summary</h2>

                        <p><b>$city->{'name'}</b> is a $city->{'economydescription'}, $city->{'description'}  of around $city->{'population'}->{'size'} in the $city->{'realm'}$city->{'dominant_race'}.$districts It has a $city->{'climate'}->{'content'} climate.</p>

                    </header>";
}
sub describe_geography {
    my $landmarks= print_landmarks();
    my $neighbors= print_neighbors();
    my $port= ( $city->{'location'}->{'port'} ) ? ' and is a port town' : '';
    my $content="
                    <section id='geography'>
                        <h2>Geography</h2>
                        <p>This $city->{'poptype'} $city->{'size'} is located $city->{'location'}->{'name'}$port. The $city->{'popdensity'}->{'type'} populated town proper is $city->{'shape'} $city->{'area'} hectare region, and is supported by a $city->{'supportarea'} hectare region. $landmarks The surrounding region is $city->{'topography'}. $neighbors</p>
                    </section>
";
}
sub describe_port {
    if   ( $city->{'location'}->{'port'} ){
        return " There is a port on the ".$city->{'location'}->{'portdirection'}." side of the city.";
    }

}
sub describe_walls {
    if   ( $city->{'walls'}->{'content'} eq 'none'){
        return " No walls currently surround the city."
    }else{
        return " Visitors are greeted with a ".$city->{'walls'}->{'content'}. " that is ".$city->{'walls'}->{'height'}." feet tall. The city wall protects the core $city->{'walls'}->{'protectedpercent'}% of the city, with $city->{'walls'}->{'towercount'} towers spread along the $city->{'walls'}->{'length'} yard wall.";
    }
    
}
sub describe_roads {
    return " The city is lined with ". $city->{'streets'}->{ 'content'}.".";
}
sub describe_districts {
    my $content="
                <h3>Districts</h3>";
    if (scalar(@{ $city->{'districts'}})>0){
         $content.="                   The city contains the following Districts:";
        return $content."<ul><li>".join('</li><li>',@{ $city->{'districts'}})."</li></ul>";
    }else{
        return $content."The city contains no districts.";
    }
}
sub describe_housing {
    my @housing;
    foreach my $key (keys %{$city->{'housing'}}){
        if ($key ne "total" and $key ne "abandoned"){
            push @housing, "$key: ".$city->{'housing'}->{$key};
        }
    }
    return "<ul><li>".join('</li><li>',@housing)."</li></ul> <p>Total: $city->{'housing'}->{'total'} homes, $city->{'housing'}->{'abandoned'} abandoned.";
}

sub describe_businesses {

    #return Dumper $city->{'business'};
    if ( scalar( keys %{ $city->{'business'} } ) > 0 ) {
        my @businesses;
        my $buildingcount   = 0;
        my $specialistcount = 0;
        foreach my $key ( sort keys %{ $city->{'business'} } ) {
            my $business = $city->{'business'}->{$key};
            push @businesses, $business->{'count'} . " " . $key . " ($business->{'specialists'} specialists)";
            $specialistcount += $business->{'specialists'};
            $buildingcount   += $business->{'count'};
        } ## end foreach my $key ( sort keys...)
        return
              "You can find the following businesses:<ul><li>"
            . join( '</li><li>', @businesses )
            . "</li></ul><p>Total: $buildingcount buildings, $specialistcount specialists.</p>";
    } else {
        return "The city contains no businesses.";
    }
} ## end sub describe_businesses
sub describe_cityscape {
    my $port=describe_port();
    my $walls=describe_walls();
    my $roads=describe_roads();
    my $districts=describe_districts();
    my $housing=describe_housing();
    my $businesses=describe_businesses();
     $city->{'streets'}->{'mainroads'} = $city->{'streets'}->{'mainroads'} == 0 ? "none": $city->{'streets'}->{'mainroads'};
     $city->{'streets'}->{'mainroads'} = $city->{'streets'}->{'mainroads'} eq "1" ? "1 is": $city->{'streets'}->{'mainroads'}." are";
     $city->{'streets'}->{'roads'} = $city->{'streets'}->{'roads'} == 1 ? "is 1 road": "are ".$city->{'streets'}->{'roads'}." roads";
    my $content="
                    <section id='cityscpae'>
                        <h2>Cityscape</h2>
                        <p>There $city->{'streets'}->{'roads'} leading to $city->{'name'}; $city->{'streets'}->{'mainroads'} major.$port$walls$roads</p>
                        $districts
                        <h3>Housing</h3>
                            The city contains the following housing:$housing
                        <h3>Businesses</h3>
                            $businesses
                    </section>
";
}

###############################################################################
#
# print_neighbors - return the neighbors in an easy-to-display sentence.
#
###############################################################################
sub print_neighbors {
#    print "$seed\n";
    my $neighbors=$city->{'neighbors'};
    if(ref($neighbors) eq 'ARRAY'){
        if (scalar(@$neighbors) eq 1 ){
            return "<a href='?cityid=$neighbors->[0]->{'id'}'> $neighbors->[0]->{'name'}</a> is a neighbor. ";
        
        }elsif(scalar(@$neighbors) >1 ){
       #     print Dumper @$neighbors;
            my @neighborlist=@$neighbors;
            my $lastneighbor=pop(@neighborlist);
            my $content="Neighboring cities include ";
            foreach my $neighbor (@neighborlist){
                $content.="<a href='?cityid=$neighbor->{'id'}'> $neighbor->{'name'}</a>, ";
            }
            $content.=" and <a href='?cityid=$lastneighbor->{'id'}'> $lastneighbor->{'name'}</a>. ";

            return $content; 
        }else{
            return "";
        }
    }
}
###############################################################################
#
# print_landmarks - return the landmarks in an easy-to-display sentence.
#
###############################################################################
sub print_landmarks {
    my $landmarks=$city->{'location'}->{'landmarks'};
    if(ref($landmarks) eq 'ARRAY'){
        if (scalar(@$landmarks) eq 1 ){
            return "A nearby ".$landmarks->[0]." is a local landmark.";
        
        } elsif( scalar(@$landmarks) >1 ){
            my $landmarklist=" and ".(pop(@{$landmarks}));
            return "Local landmarks include a ".join(', ', @{$landmarks}) . $landmarklist .".";
        }else{
            return "";
        }
    }
}


###############################################################################
#
# print_style - a simple style to make lists pretty.
#
###############################################################################
sub print_style{

    return <<EOF
        <style type='text/css'>
            body{
                background-color:#44aa44;
            }
            section, header{
                padding:5px;
                width:800px;
                margin:auto;
            
            }
            ul{   
                -moz-column-width:222px;
                -webkit-column-width:222px ;
            } 
            .one-column {
                -moz-column-width:800px;
                -webkit-column-width:800px ;
            } 
            .one-column li {
                padding-bottom:5px;
            } 
            .two-column ul{
                -moz-column-width:250px;
                -webkit-column-width:250px ;
            } 
        </style>


EOF
;

}


